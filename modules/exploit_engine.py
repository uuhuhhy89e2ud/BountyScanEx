import subprocess
import json

def run(scan_results):
    exploited = []
    for result in scan_results:
        data = json.loads(result['raw'])
        url = data.get("matched-at", "")
        template = data.get("template", "")

        if "xss" in template:
            try:
                cmd = f"dalfox url '{url}' --quiet --only-poc"
                output = subprocess.check_output(cmd, shell=True).decode()
                if output.strip():
                    exploited.append({
                        'vuln': "XSS",
                        'target': url,
                        'tool': 'dalfox',
                        'poc': output.strip(),
                        'status': 'Exploitable'
                    })
            except:
                pass

        if "sqli" in template or "sql-injection" in template:
            try:
                cmd = f"sqlmap -u '{url}' --batch --level=1 --risk=1 --answer=quit=Y --crawl=0"
                output = subprocess.check_output(cmd, shell=True).decode()
                if "is vulnerable" in output or "GET parameter" in output:
                    exploited.append({
                        'vuln': "SQLi",
                        'target': url,
                        'tool': 'sqlmap',
                        'poc': "Confirmed by sqlmap",
                        'status': 'Exploitable'
                    })
            except:
                pass

    return exploited

